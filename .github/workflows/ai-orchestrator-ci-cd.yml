name: AI Orchestrator CI/CD

on:
  pull_request:
    branches: ["main"]
    paths:
      - ".github/workflows/ai-orchestrator-ci-cd.yml"
      - "ai-orchestrator/**"
      - "!ai-orchestrator/README.md"
      - "!ai-orchestrator/.env.example"
      - "!ai-orchestrator/.gitignore"
      - "!ai-orchestrator/.idea/**"
      - "!ai-orchestrator/server.pid"
  push:
    branches: ["main"]
    paths:
      - ".github/workflows/ai-orchestrator-ci-cd.yml"
      - "ai-orchestrator/**"
      - "!ai-orchestrator/README.md"
      - "!ai-orchestrator/.env.example"
      - "!ai-orchestrator/.gitignore"
      - "!ai-orchestrator/.idea/**"
      - "!ai-orchestrator/server.pid"
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: ai-orchestrator-ci-cd-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  RELEASE_ID: ${{ github.sha }}
  DOCKER_IMAGE: ${{ secrets.DOCKER_IMAGE }}
  MESSAGE: >-
    ${{
      github.event.head_commit.message ||
      github.workflow
    }}

jobs:
  ci:
    name: CI
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Mark CI start
        id: ci_time
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          sparse-checkout: ai-orchestrator
          sparse-checkout-cone-mode: false

      - name: Install ruff
        run: pip install ruff

      - name: Lint
        id: time_lint
        run: |
          start=$(date +%s)
          # ruff check ai-orchestrator
          end=$(date +%s)
          echo "start=${start}" >> "$GITHUB_OUTPUT"
          echo "end=${end}" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub (push only)
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build
        id: time_build
        run: |
          start=$(date +%s)
          docker build \
           -f ai-orchestrator/Dockerfile \
           -t "${{ env.DOCKER_IMAGE }}:${{ env.RELEASE_ID}}" \
           ai-orchestrator
          end=$(date +%s)
          echo "start=${start}" >> "$GITHUB_OUTPUT"
          echo "end=${end}" >> "$GITHUB_OUTPUT"

      - name: Push (push only)
        if: github.event_name == 'push'
        run: |
          docker push "${{ env.DOCKER_IMAGE }}:${{ env.RELEASE_ID}}"

      - name: Mark CI end
        id: ci_time_end
        if: always()
        run: echo "end=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: Notify (CI)
        if: always()
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          MESSAGE: ${{ env.MESSAGE }}
          JOB_STATUS: ${{ job.status }}
          RELEASE_ID: ${{ env.RELEASE_ID }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          TIMESTAMP: ${{ github.event.head_commit.timestamp || github.event.pull_request.updated_at }}
          ACTOR: ${{ github.actor }}
          BRANCH: ${{ github.ref_name }}
          EVENT_NAME: ${{ github.event_name }}

          CI_START: ${{ steps.ci_time.outputs.start }}
          CI_END: ${{ steps.ci_time_end.outputs.end }}
          LINT_S: ${{ steps.time_lint.outputs.start }}
          LINT_E: ${{ steps.time_lint.outputs.end }}
          BUILD_S: ${{ steps.time_build.outputs.start }}
          BUILD_E: ${{ steps.time_build.outputs.end }}
        run: |
          set -euo pipefail

          [ -z "${WEBHOOK:-}" ] && echo "⚠️ DISCORD_WEBHOOK_URL이 공백이므로 본 단계를 스킵합니다." && exit 0

          # 안전한 산술 계산용 함수
          dur() { local s="${1:-}" e="${2:-}"; [ -n "$s" ] && [ -n "$e" ] && echo $((e - s)) || echo 0; }

          ci_total="$(dur "$CI_START" "$CI_END")"
          lint_sec="$(dur "$LINT_S" "$LINT_E")"
          build_sec="$(dur "$BUILD_S" "$BUILD_E")"

          TIMESTAMP="${TIMESTAMP:-$(date -u +%FT%TZ)}"

          if [ "$JOB_STATUS" = "success" ]; then
            TITLE="✅ [AI] CI Success"
            COLOR=5763719
          elif [ "$JOB_STATUS" = "cancelled" ]; then
            TITLE="⚠️ [AI] CI Cancelled"
            COLOR=16776988
          elif [ "$JOB_STATUS" = "skipped" ]; then
            TITLE="⏭️ [AI] CI Skipped"
            COLOR=9807270
          else
            TITLE="❌ [AI] CI Failed"
            COLOR=15548997
          fi

          # 개행 문자 및 따옴표 제거, 200자로 자름
          safe_msg=$(echo "$MESSAGE" | tr '\n' ' ' | sed 's/"/\\"/g' | head -c 200)

          JSON_PAYLOAD=$(cat <<JSON
          {
            "embeds": [
              {
                "title": "$TITLE",
                "url": "$RUN_URL",
                "color": $COLOR,
                "description": "${safe_msg}",
                "fields": [
                  {"name":"Release ID","value":"\`${RELEASE_ID}\`","inline":false},

                  {"name":"Actor","value":"${ACTOR}","inline":true},
                  {"name":"Branch","value":"${BRANCH}","inline":true},
                  {"name": "Event Name","value":"${EVENT_NAME}","inline":true},

                  {"name":"Total CI","value":"${ci_total}s","inline":true},
                  {"name":"Lint","value":"${lint_sec}s","inline":true},
                  {"name":"Build","value":"${build_sec}s","inline":true}
                ],
                "timestamp": "$TIMESTAMP"
              }
            ]
          }
          JSON
          )

          curl -sS -X POST -H "Content-Type: application/json" --data-binary "$JSON_PAYLOAD" "$WEBHOOK" || true

  cd:
    name: CD
    runs-on: ubuntu-latest
    needs: ci
    timeout-minutes: 15

    if: github.event_name == 'push' && github.ref_name == 'main'

    steps:
      - name: Mark CD start
        id: cd_time
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: Checkout (for docker-compose.yml, deploy.sh)
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            ai-orchestrator/deploy.sh
            ai-orchestrator/docker-compose.yml
          sparse-checkout-cone-mode: false

      - name: Upload to VM Instance
        id: scp
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.AI_HOST }}
          username: ${{ secrets.AI_USERNAME }}
          key: ${{ secrets.AI_SSH_KEY }}
          source: ai-orchestrator/
          target: "/tmp"

      - name: Deploy
        id: deploy
        uses: appleboy/ssh-action@v1.2.4
        env:
          DOCKER_IMAGE: ${{ env.DOCKER_IMAGE }}
          RELEASE_ID: ${{ env.RELEASE_ID }}
          ENV_FILE_B64: ${{ secrets.ENV_FILE_B64 }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        with:
          host: ${{ secrets.AI_HOST }}
          username: ${{ secrets.AI_USERNAME }}
          key: ${{ secrets.AI_SSH_KEY }}
          envs: DOCKER_IMAGE,RELEASE_ID,ENV_FILE_B64,DOCKERHUB_USERNAME,DOCKERHUB_TOKEN
          script: |
            set -euo pipefail

            AI_DIR="${{ secrets.AI_DIR }}"
            mkdir -p "${AI_DIR}"
            cd "${AI_DIR}"

            cp -f /tmp/ai-orchestrator/deploy.sh "${AI_DIR}/deploy.sh"
            cp -f /tmp/ai-orchestrator/docker-compose.yml "${AI_DIR}/docker-compose.yml"

            chmod +x ./deploy.sh

            export IMAGE="${DOCKER_IMAGE}"
            export RELEASE_ID="${RELEASE_ID}"
            export ENV_FILE_B64="${ENV_FILE_B64}"
            export DOCKERHUB_USERNAME="${DOCKERHUB_USERNAME}"
            export DOCKERHUB_TOKEN="${DOCKERHUB_TOKEN}"

            ./deploy.sh

      - name: Mark CD end
        id: cd_time_end
        if: always()
        run: echo "end=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: Notify (CD)
        if: always()
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          MESSAGE: ${{ env.MESSAGE }}
          JOB_STATUS: ${{ job.status }}
          RELEASE_ID: ${{ env.RELEASE_ID }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          TIMESTAMP: ${{ github.event.head_commit.timestamp }}
          ACTOR: ${{ github.actor }}
          BRANCH: ${{ github.ref_name }}
          CD_START: ${{ steps.cd_time.outputs.start }}
          CD_END: ${{ steps.cd_time_end.outputs.end }}
        run: |
          set -euo pipefail

          [ -z "${WEBHOOK:-}" ] && echo "⚠️ DISCORD_WEBHOOK_URL이 공백이므로 본 단계를 스킵합니다." && exit 0

          # 안전한 산술 계산용 함수
          dur() { local s="${1:-}" e="${2:-}"; [ -n "$s" ] && [ -n "$e" ] && echo $((e - s)) || echo 0; }

          cd_total="$(dur "$CD_START" "$CD_END")"

          TIMESTAMP="${TIMESTAMP:-$(date -u +%FT%TZ)}"

          if [ "$JOB_STATUS" = "success" ]; then
            TITLE="✅ [AI] CD Success"
            COLOR=5763719
          elif [ "$JOB_STATUS" = "cancelled" ]; then
            TITLE="⚠️ [AI] CD Cancelled"
            COLOR=16776988
          elif [ "$JOB_STATUS" = "skipped" ]; then
            TITLE="⏭️ [AI] CD Skipped"
            COLOR=9807270
          else
            TITLE="❌ [AI] CD Failed"
            COLOR=15548997
          fi

          # 개행 문자 및 따옴표 제거, 200자로 자름
          safe_msg=$(echo "$MESSAGE" | tr '\n' ' ' | sed 's/"/\\"/g' | head -c 200)

          JSON_PAYLOAD=$(cat <<JSON
          {
            "embeds": [
              {
                "title": "$TITLE",
                "url": "$RUN_URL",
                "color": $COLOR,
                "description": "${safe_msg}",
                "fields": [
                  {"name":"Release ID","value":"\`${RELEASE_ID}\`","inline":false},

                  {"name":"Actor","value":"${ACTOR}","inline":true},
                  {"name":"Branch","value":"${BRANCH}","inline":true},
                  {"name":"Total CD","value":"${cd_total}s","inline":true}
                ],
                "timestamp": "$TIMESTAMP"
              }
            ]
          }
          JSON
          )

          curl -sS -X POST -H "Content-Type: application/json" --data-binary "$JSON_PAYLOAD" "$WEBHOOK" || true
