name: AI Orchestrator Rollback

on:
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: ai-orchestrator-rollback-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  MESSAGE: >-
    ${{
      github.event.head_commit.message ||
      github.workflow
    }}

jobs:
  guard:
    name: Guard
    runs-on: ubuntu-latest
    steps:
      - run: |
          if [[ "${GITHUB_REF_NAME}" != "main" ]]; then
            echo "âŒ main ë¸Œëžœì¹˜ì— ëŒ€í•´ì„œë§Œ ë¡¤ë°± ì›Œí¬í”Œë¡œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤."
            exit 1
          fi

  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    needs: guard
    timeout-minutes: 5

    steps:
      - name: Prepare rollback to backup link
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.AI_HOST }}
          username: ${{ secrets.AI_USERNAME }}
          key: ${{ secrets.AI_SSH_KEY }}
          port: ${{ secrets.AI_PORT }}
          script: |
            set -euo pipefail

            AI_DIR="${{ secrets.AI_DIR }}"
            CURRENT_LINK="${AI_DIR}/current"
            BACKUP_LINK="${AI_DIR}/backup"

            echo "ðŸŒ AI ì„œë²„ì—ì„œ backupìœ¼ë¡œ ë¡¤ë°±(prepare)ì„ ì§„í–‰í•©ë‹ˆë‹¤."

            if [ ! -e "${CURRENT_LINK}" ] || [ ! -e "${BACKUP_LINK}" ]; then
              echo "âŒ current/backup ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤."
              echo "  current=${CURRENT_LINK}"
              echo "  backup=${BACKUP_LINK}"
              exit 1
            fi

            BACKUP_RELEASE="$(readlink -f "${BACKUP_LINK}" || true)"
            CURRENT_RELEASE="$(readlink -f "${CURRENT_LINK}" || true)"

            if [ -z "${BACKUP_RELEASE}" ] || [ ! -d "${BACKUP_RELEASE}" ]; then
              echo "âŒ backup releaseê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${BACKUP_RELEASE}"
              exit 1
            fi
            if [ -z "${CURRENT_RELEASE}" ] || [ ! -d "${CURRENT_RELEASE}" ]; then
              echo "âŒ current releaseê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${CURRENT_RELEASE}"
              exit 1
            fi

            ln -sfn "${BACKUP_RELEASE}" "${CURRENT_LINK}"
            ln -sfn "${CURRENT_RELEASE}" "${BACKUP_LINK}"

            echo "âœ… prepare ì™„ë£Œ"
            echo "  current -> ${BACKUP_RELEASE}"
            echo "  backup  -> ${CURRENT_RELEASE}"

  perform:
    name: Perform
    runs-on: ubuntu-latest
    needs: [guard, prepare]
    timeout-minutes: 15

    steps:
      - name: Perform Rollback
        id: perform_rollback
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.AI_HOST }}
          username: ${{ secrets.AI_USERNAME }}
          key: ${{ secrets.AI_SSH_KEY }}
          port: ${{ secrets.AI_PORT }}
          script: |
            set -euo pipefail

            AI_DIR="${{ secrets.AI_DIR }}"
            CURRENT_LINK="${AI_DIR}/current"

            APP_NAME="app-ai"
            APP_MODULE="app.main:app"
            PORT="8000"

            echo "ðŸš€ perform ë‹¨ê³„: current ê¸°ì¤€ìœ¼ë¡œ ì˜ì¡´ì„±/í”„ë¡œì„¸ìŠ¤ ìž¬ê¸°ë™"

            if [ ! -e "${CURRENT_LINK}" ]; then
              echo "âŒ current ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤: ${CURRENT_LINK}"
              exit 1
            fi

            umask 022
            echo "${{ secrets.ENV_FILE_B64 }}" | base64 -d > "${CURRENT_LINK}/.env"

            if [ ! -d "${AI_DIR}/venv" ]; then
              python3 -m venv "${AI_DIR}/venv"
            fi

            "${AI_DIR}/venv/bin/python" -m pip install --upgrade pip wheel setuptools

            if [ -f "${CURRENT_LINK}/requirements.txt" ]; then
              "${AI_DIR}/venv/bin/pip" install -r "${CURRENT_LINK}/requirements.txt"
            else
              echo "âŒ requirements.txt not found in ${CURRENT_LINK}"
              exit 1
            fi

            pm2 describe "${APP_NAME}" >/dev/null 2>&1 && pm2 delete "${APP_NAME}" || true

            cd "${CURRENT_LINK}"
            PORT="${PORT}" pm2 start "${AI_DIR}/venv/bin/uvicorn" \
              --name "${APP_NAME}" \
              --interpreter none \
              -- \
              "${APP_MODULE}" --host 0.0.0.0 --port "${PORT}"
            pm2 save

            echo "âœ… perform ì™„ë£Œ"
            echo "current=$(readlink -f "${CURRENT_LINK}" || true)"
            pm2 status || true

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [guard, prepare, perform]
    if: always()

    steps:
      - name: Notify Discord (Rollback)
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          MESSAGE: ${{ env.MESSAGE }}
          JOB_STATUS: ${{ (needs.guard.result == 'success' && needs.prepare.result == 'success' && needs.perform.result == 'success') && 'success' || 'failure' }}
          ACTOR: ${{ github.actor }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          GUARD: ${{ needs.guard.result }}
          PREPARE: ${{ needs.prepare.result }}
          PERFORM: ${{ needs.perform.result }}
        run: |
          set -euo pipefail

          [ -z "${DISCORD_WEBHOOK_URL:-}" ] && echo "[WARN] DISCORD_WEBHOOK_URL is empty. Skip." && exit 0

          if [ "${JOB_STATUS}" = "success" ]; then color=5763719
          else color=15548997
          fi

          safe_msg=$(echo "${MESSAGE}" | tr '\n' ' ' | sed 's/"/\\"/g' | head -c 200)

          payload=$(cat <<JSON
          {
            "embeds": [
              {
                "title": "[AI] Rollback ${JOB_STATUS}",
                "url": "${RUN_URL}",
                "color": ${color},
                "description": "${safe_msg}",
                "fields": [
                  {"name":"Release ID","value":"backup","inline":true},
                  {"name":"Actor","value":"${ACTOR}","inline":true},
                  {"name":"Branch","value":"${GITHUB_REF_NAME}","inline":true},
                  {"name":"Guard","value":"\`${GUARD}\`","inline":true},
                  {"name":"Prepare","value":"\`${PREPARE}\`","inline":true},
                  {"name":"Perform","value":"\`${PERFORM}\`","inline":true}
                ],
                "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
              }
            ]
          }
          JSON
          )

          curl -sS -X POST -H "Content-Type: application/json" --data-binary "$payload" "${DISCORD_WEBHOOK_URL}" >/dev/null
