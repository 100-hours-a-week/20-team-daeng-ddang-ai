name: AI Orchestrator Rollback

on:
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: ai-orchestrator-rollback-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  guard:
    name: Guard
    runs-on: ubuntu-latest
    steps:
      - run: |
          if [[ "${GITHUB_REF_NAME}" != "main" ]]; then
            echo "❌ main 브랜치에 대해서만 롤백 워크플로를 실행할 수 있습니다."
            exit 1
          fi

  rollback:
    name: Rollback
    runs-on: ubuntu-latest
    needs: guard
    timeout-minutes: 10

    outputs:
      rb_start: ${{ steps.rb_time.outputs.start }}
      rb_end: ${{ steps.rb_time_end.outputs.end }}

    steps:
      - name: Mark Rollback start
        id: rb_time
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: Checkout (for rollback.sh)
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            ai-orchestrator/rollback.sh
          sparse-checkout-cone-mode: false

      - name: Upload to VM Instance
        id: scp
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.AI_HOST }}
          username: ${{ secrets.AI_USERNAME }}
          key: ${{ secrets.AI_SSH_KEY }}
          source: ai-orchestrator/
          target: "/tmp"

      - name: Rollback
        id: rollback
        uses: appleboy/ssh-action@v1.2.4
        env:
          DOCKER_IMAGE: ${{ secrets.DOCKER_IMAGE }}
          ENV_FILE_B64: ${{ secrets.ENV_FILE_B64 }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        with:
          host: ${{ secrets.AI_HOST }}
          username: ${{ secrets.AI_USERNAME }}
          key: ${{ secrets.AI_SSH_KEY }}
          envs: DOCKER_IMAGE,ENV_FILE_B64,DOCKERHUB_USERNAME,DOCKERHUB_TOKEN
          script: |
            set -euo pipefail

            AI_DIR="${{ secrets.AI_DIR }}"
            mkdir -p "${AI_DIR}"
            cd "${AI_DIR}"

            cp -f /tmp/ai-orchestrator/rollback.sh "${AI_DIR}/rollback.sh"
            chmod +x "${AI_DIR}/rollback.sh"

            export IMAGE="${DOCKER_IMAGE}"
            export ENV_FILE_B64="${ENV_FILE_B64}"
            export DOCKERHUB_USERNAME="${DOCKERHUB_USERNAME}"
            export DOCKERHUB_TOKEN="${DOCKERHUB_TOKEN}"

            ./rollback.sh

      - name: Mark Rollback end
        id: rb_time_end
        if: always()
        run: echo "end=$(date +%s)" >> "$GITHUB_OUTPUT"

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [guard, rollback]
    if: always()

    steps:
      - name: Notify (Rollback)
        if: always()
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          ACTOR: ${{ github.actor }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          GUARD_STATUS: ${{ needs.guard.result }}
          ROLLBACK_STATUS: ${{ needs.rollback.result }}
          RB_START: ${{ needs.rollback.outputs.rb_start }}
          RB_END: ${{ needs.rollback.outputs.rb_end }}
        run: |
          set -euo pipefail

          [ -z "${WEBHOOK:-}" ] && echo "⚠️ DISCORD_WEBHOOK_URL이 공백이므로 본 단계를 스킵합니다." && exit 0

          # 안전한 산술 계산용 함수
          DURATION="N/A"
          if [[ -n "${RB_START:-}" && -n "${RB_END:-}" ]]; then
            DURATION="$((RB_END - RB_START))s"
          fi
          TIMESTAMP="${TIMESTAMP:-$(date -u +%FT%TZ)}"

          if [ "${GUARD_STATUS}" != "success" ]; then
            JOB_STATUS="${GUARD_STATUS}"
          else
            JOB_STATUS="${ROLLBACK_STATUS}"
          fi

          case "${JOB_STATUS}" in
            success)   TITLE="✅ [AI] Rollback Success"; COLOR=5763719 ;;
            failure)   TITLE="❌ [AI] Rollback Failed"; COLOR=15548997 ;;
            cancelled) TITLE="⚠️ [AI] Rollback Cancelled"; COLOR=16776988 ;;
            *)         TITLE="❓ [AI] Rollback Status: ${JOB_STATUS}"; COLOR=9807270 ;;
          esac

          JSON_PAYLOAD=$(cat <<JSON
          {
            "embeds": [
              {
                "title": "$TITLE",
                "url": "$RUN_URL",
                "color": $COLOR,
                "fields": [
                  {"name":"Actor","value":"${ACTOR}","inline":true},
                  {"name":"Duration","value":"${DURATION}","inline":true},
                  {"name":"Guard","value":"\`${GUARD_STATUS}\`","inline":true},
                  {"name":"Rollback","value":"\`${ROLLBACK_STATUS}\`","inline":true}
                ],
                "timestamp": "$TIMESTAMP"
              }
            ]
          }
          JSON
          )

          curl -sS -X POST -H "Content-Type: application/json" --data-binary "$JSON_PAYLOAD" "$WEBHOOK" || true
